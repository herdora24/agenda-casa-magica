<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Citas - La Casa Mágica</title>
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SDK de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary-pink: #E54B9A;
            --dark-accent: #1F2937; 
            --light-bg: #F9FAFB;    
            --white: #FFFFFF;
            --soft-gray: #F3F4F6;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--light-bg); }
        h1, h2, h3, .font-display { font-family: 'Playfair Display', serif; }
        .btn-primary { background-color: var(--primary-pink); color: var(--white); transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #C73782; }
        .time-slot { transition: all 0.2s ease-in-out; }
        .time-slot:not(.disabled):hover { transform: scale(1.05); background-color: var(--primary-pink); color: var(--white); border-color: var(--primary-pink); }
        .time-slot.selected { background-color: var(--dark-accent); color: var(--white); border-color: var(--dark-accent); }
        .time-slot.disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        .admin-sidebar { background-color: var(--white); color: #374151; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .admin-sidebar-mobile { transition: transform 0.3s ease-in-out; background-color: var(--white); color: #374151; }
        .admin-tab { color: #4B5563; }
        .admin-tab.active { background-color: var(--primary-pink); color: var(--white); }
        .admin-tab:hover:not(.active) { background-color: var(--soft-gray); }
        .agenda-grid { display: grid; grid-template-columns: 60px repeat(auto-fit, minmax(160px, 1fr)); }
        .agenda-time { grid-column: 1 / 2; }
        .agenda-slot { min-height: 100px; }
        .note-card { background-color: #FFFBEB; border-left: 3px solid #FBBF24; }
        /* Estilos para el nuevo acordeón */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-button .accordion-arrow { transition: transform 0.3s ease; }
        .accordion-button.active .accordion-arrow { transform: rotate(180deg); }
    </style>
</head>
<body class="text-gray-800">

    <!-- === VISTA PRINCIPAL (CLIENTE Y LOGIN DE ADMIN) === -->
    <div id="main-view">
        <div id="client-view" class="max-w-2xl mx-auto p-4 md:p-8">
            <header class="text-center mb-10">
                <i class="fas fa-wand-magic-sparkles text-5xl text-[var(--primary-pink)]"></i>
                <h1 class="text-5xl font-bold text-gray-900 mt-4">La Casa Mágica</h1>
                <p class="text-gray-600 mt-2 text-lg">Agenda tu cita y vive la magia</p>
            </header>

            <div id="booking-steps" class="space-y-10">
                <div>
                    <h2 class="text-2xl font-display mb-4 border-l-4 border-[var(--primary-pink)] pl-4">1. Elige un servicio</h2>
                    <div id="services-list" class="space-y-3"></div>
                </div>
                <div id="date-time-step" class="hidden">
                    <h2 class="text-2xl font-display mb-4 border-l-4 border-[var(--primary-pink)] pl-4">2. Elige fecha y hora</h2>
                    <input type="date" id="date-picker" class="w-full p-3 rounded-lg border border-gray-300 mb-6 focus:ring-2 focus:ring-[var(--primary-pink)]">
                    <div id="time-slots" class="grid grid-cols-3 md:grid-cols-4 gap-3"></div>
                </div>
                <div id="confirm-step" class="hidden">
                    <h2 class="text-2xl font-display mb-4 border-l-4 border-[var(--primary-pink)] pl-4">3. Confirma tus datos</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                        <p><strong>Servicio:</strong> <span id="confirm-service" class="font-medium"></span></p>
                        <p><strong>Fecha:</strong> <span id="confirm-date" class="font-medium"></span></p>
                        <p><strong>Hora:</strong> <span id="confirm-time" class="font-medium"></span></p>
                        <input type="text" id="client-name" placeholder="Tu nombre completo" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[var(--primary-pink)]">
                        <input type="tel" id="client-phone" placeholder="Tu número de WhatsApp (10 dígitos)" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[var(--primary-pink)]" maxlength="10" pattern="[0-9]*" inputmode="numeric">
                        <textarea id="client-notes" placeholder="Notas u observaciones (opcional)" rows="3" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[var(--primary-pink)]"></textarea>
                        <button id="confirm-booking-btn" class="btn-primary w-full py-3 rounded-lg font-bold text-lg transition-transform hover:scale-105">¡Confirmar mi Cita!</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="absolute top-4 right-4">
            <button id="open-login-btn" class="bg-[var(--dark-accent)] text-white px-4 py-2 rounded-lg hover:bg-black text-sm"><i class="fas fa-user-shield mr-2"></i>Admin</button>
        </div>
    </div>

    <!-- === VISTA DE ADMINISTRADOR === -->
    <div id="admin-view" class="hidden">
        <div class="flex min-h-screen bg-gray-100">
            <!-- Sidebar para móvil -->
            <div id="mobile-sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
            <div id="mobile-sidebar" class="admin-sidebar-mobile fixed top-0 left-0 w-64 h-full z-30 transform -translate-x-full md:hidden">
                <!-- Contenido del sidebar móvil se inyectará aquí -->
            </div>

            <!-- Sidebar para desktop -->
            <aside class="admin-sidebar w-64 flex-shrink-0 flex-col hidden md:flex">
                <div class="text-center py-6 border-b border-gray-200">
                    <h2 class="text-2xl font-display font-bold text-[var(--dark-accent)]">Panel Mágico</h2>
                </div>
                <nav id="admin-tabs-nav" class="flex-1 px-4 py-6 space-y-2">
                    <a href="#" data-tab="agenda" class="admin-tab flex items-center px-4 py-3 rounded-lg"><i class="fas fa-calendar-days w-6 mr-3"></i>Agenda</a>
                    <a href="#" data-tab="categorias" class="admin-tab flex items-center px-4 py-3 rounded-lg"><i class="fas fa-layer-group w-6 mr-3"></i>Categorías</a>
                    <a href="#" data-tab="servicios" class="admin-tab flex items-center px-4 py-3 rounded-lg"><i class="fas fa-wand-magic-sparkles w-6 mr-3"></i>Servicios</a>
                    <a href="#" data-tab="equipo" class="admin-tab flex items-center px-4 py-3 rounded-lg"><i class="fas fa-users w-6 mr-3"></i>Equipo</a>
                    <a href="#" data-tab="horarios" class="admin-tab flex items-center px-4 py-3 rounded-lg"><i class="fas fa-business-time w-6 mr-3"></i>Horarios</a>
                </nav>
                <div class="px-4 py-4 border-t border-gray-200">
                    <button id="logout-btn" class="w-full bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700"><i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión</button>
                </div>
            </aside>
            
            <div class="flex-1 flex flex-col">
                <header class="md:hidden flex justify-between items-center p-4 bg-white shadow-md">
                     <button id="open-menu-btn" class="text-2xl text-gray-700">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 class="text-xl font-bold text-[var(--primary-pink)]">La Casa Mágica</h2>
                    <div class="w-8"></div>
                </header>
                <main class="flex-1 p-4 sm:p-6 md:p-10 overflow-y-auto">
                    <div id="admin-content"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- === MODALES === -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <div class="text-center mb-6">
                <i class="fas fa-lock text-4xl text-indigo-500"></i>
                <h2 class="text-2xl font-bold text-gray-800 mt-4">Acceso de Administrador</h2>
            </div>
            <form id="login-form">
                <input type="password" id="password" placeholder="Contraseña" class="w-full px-4 py-3 mb-4 rounded-md border-gray-300">
                <button type="submit" class="w-full bg-indigo-500 text-white py-3 rounded-lg font-semibold hover:bg-indigo-600">Ingresar</button>
            </form>
        </div>
    </div>
    <div id="notification-modal" class="hidden fixed bottom-10 right-10 text-white px-6 py-4 rounded-lg shadow-lg z-50 animate-bounce">
        <p id="notification-message"></p>
    </div>
    <div id="admin-booking-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-display font-bold mb-4">Agendar Nueva Cita</h2>
            <form id="admin-booking-form" class="space-y-4">
                <input type="hidden" id="admin-book-staff">
                <input type="hidden" id="admin-book-time">
                <input type="hidden" id="admin-book-date">
                <div><label>Cliente:</label><input type="text" id="admin-book-client-name" class="w-full p-2 border rounded" required></div>
                <div><label>WhatsApp Cliente:</label><input type="tel" id="admin-book-client-phone" class="w-full p-2 border rounded" required maxlength="10" pattern="[0-9]*" inputmode="numeric"></div>
                <div><label>Servicio:</label><select id="admin-book-service" class="w-full p-2 border rounded" required></select></div>
                <div><label>Notas (opcional):</label><textarea id="admin-book-notes" rows="3" class="w-full p-2 border rounded"></textarea></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="admin-book-cancel" class="bg-gray-300 px-4 py-2 rounded">Cancelar</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded">Confirmar Cita</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
             <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                <i id="confirm-icon" class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
            </div>
            <h2 id="confirm-title" class="text-2xl font-bold mb-2"></h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 px-6 py-2 rounded-lg font-semibold">Cancelar</button>
                <button id="confirm-ok-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold">Aceptar</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =========================================================================
        // CONFIGURACIÓN DE FIREBASE 
        // =========================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyB1V6cCuFUWqVPpx2LX1KKuoU1ikDkFjcw",
          authDomain: "agenda-casa-magica.firebaseapp.com",
          databaseURL: "https://agenda-casa-magica-default-rtdb.firebaseio.com",
          projectId: "agenda-casa-magica",
          storageBucket: "agenda-casa-magica.appspot.com",
          messagingSenderId: "733679225840",
          appId: "1:733679225840:web:cb02ebb1b0d040104bab35"
        };
        // =========================================================================

        let database;
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();

        const settingsRef = database.ref('settings');
        const appointmentsRef = database.ref('appointments');
        
        const getInitialState = () => ({
            password: 'admin',
            serviceCategories: ['Manicure y Pedicure', 'Peluquería', 'Cejas y Pestañas'],
            services: [
                { id: 1, name: 'Manicure Semipermanente', duration: 60, category: 'Manicure y Pedicure' },
                { id: 4, name: 'Corte y Cepillado', duration: 75, category: 'Peluquería' },
                { id: 5, name: 'Lifting de Pestañas', duration: 60, category: 'Cejas y Pestañas' },
            ],
            staff: [
                { id: 1, name: 'Ana', specialties: ['Manicure y Pedicure'] },
                { id: 3, name: 'Carolina', specialties: ['Peluquería'] }
            ],
            hours: { start: '09:00', end: '19:00', interval: 30, breakStart: '13:00', breakEnd: '14:00' }
        });
        
        let appState = {
            settings: null,
            appointments: {},
            booking: { service: null, date: null, time: null }
        }; 
        let confirmCallback = null;

        const mainView = document.getElementById('main-view');
        const adminView = document.getElementById('admin-view');
        const loginModal = document.getElementById('login-modal');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const mobileSidebarBackdrop = document.getElementById('mobile-sidebar-backdrop');
        const openMenuBtn = document.getElementById('open-menu-btn');
        const desktopLogoutBtn = document.getElementById('logout-btn');

        document.getElementById('open-login-btn').addEventListener('click', () => loginModal.classList.remove('hidden'));
        loginModal.addEventListener('click', (e) => { if (e.target === loginModal) loginModal.classList.add('hidden'); });
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!appState.settings) { 
                showNotification('Datos de configuración aún cargando, por favor espere.', true);
                return;
            }
            if (document.getElementById('password').value === appState.settings.password) {
                sessionStorage.setItem('isAdminPeluqueria', 'true');
                showAdminView();
                loginModal.classList.add('hidden');
            } else {
                showNotification('Contraseña incorrecta', true);
            }
        });

        const handleLogout = () => {
            sessionStorage.removeItem('isAdminPeluqueria');
            window.location.reload();
        };

        const showAdminView = () => {
            mainView.classList.add('hidden');
            adminView.classList.remove('hidden');
            renderAdminView('agenda');
        };

        const showClientView = () => {
            mainView.classList.remove('hidden');
            adminView.classList.add('hidden');
            if (appState.settings) {
                renderServices();
            }
        };

        const formatDateForInput = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const isValidColombianPhone = (phone) => /^[0-9]{10}$/.test(phone);

        const renderServices = () => {
            const list = document.getElementById('services-list');
            list.innerHTML = '';
            if (!appState.settings || !appState.settings.services) return;
            const servicesByCategory = appState.settings.services.reduce((acc, service) => {
                (acc[service.category] = acc[service.category] || []).push(service);
                return acc;
            }, {});

            for (const category in servicesByCategory) {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'accordion-item bg-white rounded-xl shadow-lg';
                let categoryHTML = `
                    <button class="accordion-button w-full flex justify-between items-center p-5 text-left">
                        <h3 class="text-xl font-display font-bold text-gray-800">${category}</h3>
                        <i class="fas fa-chevron-down accordion-arrow text-[var(--primary-pink)] transition-transform duration-300"></i>
                    </button>
                    <div class="accordion-content px-5 pb-5">
                        <div class="border-t pt-4 space-y-3">`;
                servicesByCategory[category].forEach(service => {
                    categoryHTML += `<div class="service-card cursor-pointer flex justify-between items-center p-3 rounded-lg hover:bg-gray-100" data-service-id="${service.id}"><div><h4 class="font-bold text-md text-gray-800">${service.name}</h4><p class="text-sm text-gray-500">${service.duration} min.</p></div></div>`;
                });
                categoryHTML += `</div></div>`;
                categoryWrapper.innerHTML = categoryHTML;
                list.appendChild(categoryWrapper);
            }

            document.querySelectorAll('.accordion-button').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    button.classList.toggle('active');
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    } 
                });
            });

            document.querySelectorAll('.service-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const serviceId = parseInt(e.currentTarget.dataset.serviceId);
                    const service = appState.settings.services.find(s => s.id === serviceId);
                    selectService(service);
                });
            });
        };

        const selectService = (service) => {
            appState.booking.service = service;
            const dateTimeStep = document.getElementById('date-time-step');
            dateTimeStep.classList.remove('hidden');
            document.getElementById('date-picker').min = formatDateForInput(new Date());
            document.getElementById('date-picker').value = '';
            document.getElementById('time-slots').innerHTML = '';
            document.getElementById('confirm-step').classList.add('hidden');
            
            setTimeout(() => {
                dateTimeStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        };

        document.getElementById('date-picker').addEventListener('change', (e) => {
            appState.booking.date = e.target.value;
            renderTimeSlots();
            setTimeout(() => {
                document.getElementById('time-slots').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        });

        const renderTimeSlots = () => {
            const slotsContainer = document.getElementById('time-slots');
            slotsContainer.innerHTML = '<p class="col-span-full text-center">Calculando horarios disponibles...</p>';
            
            const selectedServiceCategory = appState.booking.service.category;
            const qualifiedStaff = appState.settings.staff.filter(s => s.specialties.includes(selectedServiceCategory));
            
            if (qualifiedStaff.length === 0) {
                slotsContainer.innerHTML = `<p class="col-span-full text-center text-red-500">Lo sentimos, no hay personal disponible para este servicio.</p>`;
                return;
            }

            const dailyAppointments = appState.appointments[appState.booking.date] || {};
            const { start, end, interval, breakStart, breakEnd } = appState.settings.hours;
            const timeSlots = [];
            let currentTime = new Date(`${appState.booking.date}T${start}`);
            const endTime = new Date(`${appState.booking.date}T${end}`);
            const breakStartTime = new Date(`${appState.booking.date}T${breakStart}`);
            const breakEndTime = new Date(`${appState.booking.date}T${breakEnd}`);
            const now = new Date();

            while (currentTime < endTime) {
                const timeStr = currentTime.toTimeString().substring(0, 5);
                const isBreakTime = currentTime >= breakStartTime && currentTime < breakEndTime;
                const slotDateTime = new Date(`${appState.booking.date}T${timeStr}`);
                const isInThePast = slotDateTime < now;

                if (!isBreakTime && !isInThePast) {
                    const appointmentsAtTime = Object.values(dailyAppointments).filter(apt => apt.startTime === timeStr);
                    const busyQualifiedStaff = appointmentsAtTime.filter(apt => qualifiedStaff.some(s => s.name === apt.staffName));
                    const isAvailable = busyQualifiedStaff.length < qualifiedStaff.length;
                    timeSlots.push({ time: timeStr, available: isAvailable });
                }
                currentTime.setMinutes(currentTime.getMinutes() + interval);
            }

            slotsContainer.innerHTML = '';
            if (timeSlots.length === 0) {
                 slotsContainer.innerHTML = '<p class="col-span-full text-center text-red-500">No hay horarios disponibles para este día.</p>';
                 return;
            }
            timeSlots.forEach(slot => {
                const button = document.createElement('button');
                button.textContent = slot.time;
                button.className = 'time-slot p-3 rounded-lg border-2 font-semibold';
                if (!slot.available) {
                    button.classList.add('disabled');
                    button.disabled = true;
                } else {
                    button.addEventListener('click', (e) => selectTime(slot.time, e));
                }
                slotsContainer.appendChild(button);
            });
        };

        const selectTime = (time, e) => {
            appState.booking.time = time;
            document.querySelectorAll('.time-slot').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            const confirmStep = document.getElementById('confirm-step');
            confirmStep.classList.remove('hidden');
            document.getElementById('confirm-service').textContent = appState.booking.service.name;
            const dateObj = new Date(appState.booking.date + 'T00:00:00');
            document.getElementById('confirm-date').textContent = dateObj.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('confirm-time').textContent = appState.booking.time;
            
            setTimeout(() => {
                confirmStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        };

        document.getElementById('confirm-booking-btn').addEventListener('click', () => {
            const { time } = appState.booking;
            
            const proceedWithBooking = () => {
                const name = document.getElementById('client-name').value.trim();
                const phone = document.getElementById('client-phone').value.trim();
                const notes = document.getElementById('client-notes').value.trim();

                if (!name || !phone) { showNotification('Por favor, completa tu nombre y WhatsApp.', true); return; }
                if (!isValidColombianPhone(phone)) {
                    showNotification('Por favor, ingresa un número de celular válido de 10 dígitos.', true);
                    return;
                }

                const { service, date, time } = appState.booking;
                const dailyAppointments = appState.appointments[date] || {};
                const qualifiedStaff = appState.settings.staff.filter(s => s.specialties.includes(service.category));
                const busyStaffAtTime = Object.values(dailyAppointments).filter(apt => apt.startTime === time).map(apt => apt.staffName);
                const availableQualifiedStaff = qualifiedStaff.filter(s => !busyStaffAtTime.includes(s.name));

                if (availableQualifiedStaff.length === 0) {
                    showNotification('Lo sentimos, alguien más agendó a esa hora. Por favor, elige otra.', true);
                    renderTimeSlots();
                    return;
                }
                
                const assignedStaff = availableQualifiedStaff[Math.floor(Math.random() * availableQualifiedStaff.length)];
                
                const appointmentData = { clientName: name, clientPhone: phone, notes, serviceName: service.name, serviceDuration: service.duration, startTime: time, staffName: assignedStaff.name };

                appointmentsRef.child(date).push(appointmentData);
                showNotification('¡Cita confirmada con éxito!');
                setTimeout(() => window.location.reload(), 2000);
            };

            if (time >= "18:00") {
                showConfirm("Aviso de Recargo", "Recuerda que las citas después de las 6:00 p.m. tienen un recargo de $10.000 COP. ¿Estás de acuerdo?", (confirmed) => { if (confirmed) proceedWithBooking(); });
            } else {
                proceedWithBooking();
            }
        });

        const renderAdminView = (tabName) => {
             document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
             const desktopTab = document.querySelector(`.admin-sidebar-desktop .admin-tab[data-tab="${tabName}"]`);
             if (desktopTab) desktopTab.classList.add('active');
             const mobileTab = mobileSidebar.querySelector(`.admin-tab[data-tab="${tabName}"]`);
             if (mobileTab) mobileTab.classList.add('active');

             const content = document.getElementById('admin-content');
             if (tabName === 'agenda') renderAdminAgenda(content);
             else if (tabName === 'categorias') renderAdminCategories(content);
             else if (tabName === 'servicios') renderAdminServices(content);
             else if (tabName === 'equipo') renderAdminStaff(content);
             else if (tabName === 'horarios') renderAdminHours(content);
        };

        const renderAdminAgenda = (container, date) => {
            const selectedDateStr = date || formatDateForInput(new Date());
            const selectedDate = new Date(selectedDateStr + 'T00:00:00');
            const { staff, hours } = appState.settings;

            let html = `<div class="flex flex-wrap justify-between items-center mb-6 gap-4"><h2 class="text-3xl font-display font-bold">Agenda de Citas</h2><div><label for="admin-date-picker" class="text-sm font-medium">Seleccionar Fecha:</label><input type="date" id="admin-date-picker" value="${selectedDateStr}" class="p-2 border rounded-md shadow-sm"></div></div><h3 class="text-xl font-semibold mb-4 text-gray-600">${selectedDate.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h3>`;
            html += `<div class="bg-white rounded-lg shadow-xl overflow-x-auto"><div class="agenda-grid p-4 min-w-[800px]">`;
            html += `<div class="agenda-time"></div>`;
            staff.forEach(person => { html += `<div class="text-center font-bold font-display p-2 border-b-2 border-gray-200">${person.name}</div>`; });

            const dailyAppointments = appState.appointments[selectedDateStr] || {};
            let currentTime = new Date(`${selectedDateStr}T${hours.start}`);
            const endTime = new Date(`${selectedDateStr}T${hours.end}`);

            while(currentTime < endTime) {
                const timeStr = currentTime.toTimeString().substring(0, 5);
                html += `<div class="agenda-time text-right pr-2 border-r border-gray-200 text-sm text-gray-500">${timeStr}</div>`;
                staff.forEach(person => {
                    const appointmentKey = Object.keys(dailyAppointments).find(key => dailyAppointments[key].staffName === person.name && dailyAppointments[key].startTime === timeStr);
                    const appointment = appointmentKey ? {id: appointmentKey, ...dailyAppointments[appointmentKey]} : null;

                    html += `<div class="agenda-slot border-r border-b border-gray-200 p-2">`;
                    if (appointment) {
                        let noteHTML = '';
                        if (appointment.notes) {
                            const truncatedNote = appointment.notes.length > 35 ? appointment.notes.substring(0, 35) + '...' : appointment.notes;
                            noteHTML = `<div class="note-card mt-2 p-1.5 text-xs"><i class="fas fa-thumbtack mr-1 text-yellow-500"></i> ${truncatedNote}</div>`;
                        }
                        html += `<div class="bg-pink-50 text-pink-900 rounded-lg p-2 text-sm h-full flex flex-col justify-between border-l-4 border-pink-400"><div><p class="font-bold text-black">${appointment.clientName}</p><p class="text-gray-700">${appointment.serviceName}</p><p class="text-xs mt-1 text-gray-500"><i class="fab fa-whatsapp"></i> ${appointment.clientPhone}</p>${noteHTML}</div><button data-date="${selectedDateStr}" data-id="${appointmentKey}" class="delete-appointment-btn text-red-500 self-end opacity-50 hover:opacity-100 text-xs"><i class="fas fa-trash"></i></button></div>`;
                    } else {
                         html += `<button data-date="${selectedDateStr}" data-time="${timeStr}" data-staff="${person.name}" class="add-appointment-btn w-full h-full flex items-center justify-center text-gray-300 hover:text-green-500 hover:bg-green-50 rounded-lg transition-colors"><i class="fas fa-plus"></i></button>`;
                    }
                    html += `</div>`;
                });
                currentTime.setMinutes(currentTime.getMinutes() + hours.interval);
            }
            html += `</div></div>`;
            container.innerHTML = html;
        };
        
        const renderAdminCategories = (container) => {
            let html = `<h2 class="text-3xl font-display font-bold mb-6">Gestionar Categorías de Servicios</h2>`;
            html += `<div class="bg-white p-6 rounded-lg shadow mb-8"><h3 class="font-semibold text-xl mb-4">Añadir Nueva Categoría</h3><form id="form-add-category" class="flex gap-4 items-end">
                        <input type="text" id="new-category-name" placeholder="Ej: Depilación, Masajes..." class="w-full p-2 border rounded" required>
                        <button type="submit" class="btn-primary py-2 px-4 rounded">Añadir</button>
                     </form></div>`;
            html += `<div class="bg-white p-6 rounded-lg shadow"><h3 class="font-semibold text-xl mb-4">Categorías Actuales</h3><div id="categories-admin-list" class="space-y-3"></div></div>`;
            container.innerHTML = html;
            
            const list = document.getElementById('categories-admin-list');
            (appState.settings.serviceCategories || []).forEach(category => {
                list.innerHTML += `<div class="p-3 border rounded-lg flex justify-between items-center"><span>${category}</span><button data-category="${category}" class="delete-category-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>`;
            });
        };

        const renderAdminServices = (container) => {
            let html = `<h2 class="text-3xl font-display font-bold mb-6">Gestionar Servicios</h2>`;
            html += `<div class="bg-white p-6 rounded-lg shadow mb-8"><h3 class="font-semibold text-xl mb-4">Añadir Nuevo Servicio</h3><form id="form-add-service" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <input type="text" id="new-service-name" placeholder="Nombre del servicio" class="w-full p-2 border rounded" required>
                        <select id="new-service-category" class="w-full p-2 border rounded" required>${(appState.settings.serviceCategories || []).map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                        <input type="number" id="new-service-duration" placeholder="Duración (min)" class="w-full p-2 border rounded" required>
                        <button type="submit" class="btn-primary py-2 px-4 rounded md:col-span-3">Añadir Servicio</button>
                     </form></div>`;
            html += `<div class="bg-white p-6 rounded-lg shadow"><h3 class="font-semibold text-xl mb-4">Servicios Actuales</h3><div id="services-admin-list" class="space-y-4"></div></div>`;
            container.innerHTML = html;
            
            const list = document.getElementById('services-admin-list');
            const servicesByCategory = (appState.settings.services || []).reduce((acc, s) => { (acc[s.category] = acc[s.category] || []).push(s); return acc; }, {});
            for (const category in servicesByCategory) {
                list.innerHTML += `<h4 class="font-bold mt-4 border-b pb-1">${category}</h4>`;
                servicesByCategory[category].forEach(s => {
                    list.innerHTML += `<div class="p-3 flex justify-between items-center"><span>${s.name} (${s.duration} min)</span><button data-id="${s.id}" class="delete-service-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>`;
                });
            }
        };

        const renderAdminStaff = (container) => {
            let html = `<h2 class="text-3xl font-display font-bold mb-6">Gestionar Equipo</h2>`;
            html += `<div class="bg-white p-6 rounded-lg shadow mb-8"><h3 class="font-semibold text-xl mb-4">Añadir Profesional</h3><form id="form-add-staff" class="space-y-4">
                        <input type="text" id="new-staff-name" placeholder="Nombre" class="w-full p-2 border rounded" required>
                        <div><p class="font-medium mb-2">Especialidades:</p><div id="new-staff-specialties" class="grid grid-cols-2 gap-2">${(appState.settings.serviceCategories || []).map(c => `<div><input type="checkbox" id="spec-${c}" value="${c}" class="mr-2"><label for="spec-${c}">${c}</label></div>`).join('')}</div></div>
                        <button type="submit" class="btn-primary py-2 px-4 rounded">Añadir al Equipo</button>
                     </form></div>`;
            html += `<div class="bg-white p-6 rounded-lg shadow"><h3 class="font-semibold text-xl mb-4">Equipo Actual</h3><div id="staff-admin-list" class="space-y-3"></div></div>`;
            container.innerHTML = html;

             const list = document.getElementById('staff-admin-list');
            (appState.settings.staff || []).forEach(s => { 
                const specialties = s.specialties.join(', ');
                list.innerHTML += `<div class="p-3 border rounded-lg flex justify-between items-center"><div><p class="font-bold">${s.name}</p><p class="text-sm text-gray-500">${specialties}</p></div><button data-id="${s.id}" class="delete-staff-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>`;
            });
        };

        const renderAdminHours = (container) => {
            const { start, end, interval, breakStart, breakEnd } = appState.settings.hours;
            container.innerHTML = `<h2 class="text-3xl font-display font-bold mb-6">Configurar Horarios</h2><div class="bg-white p-6 rounded-lg shadow"><form id="form-hours" class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="font-semibold">Hora de Apertura</label><input type="time" id="hours-start" value="${start}" class="w-full p-2 border rounded"></div><div><label class="font-semibold">Hora de Cierre</label><input type="time" id="hours-end" value="${end}" class="w-full p-2 border rounded"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="font-semibold">Inicio del Descanso</label><input type="time" id="hours-break-start" value="${breakStart}" class="w-full p-2 border rounded"></div><div><label class="font-semibold">Fin del Descanso</label><input type="time" id="hours-break-end" value="${breakEnd}" class="w-full p-2 border rounded"></div></div><div><label class="font-semibold">Intervalo de citas (minutos)</label><input type="number" id="hours-interval" value="${interval}" class="w-full p-2 border rounded"></div><button type="submit" class="bg-green-500 text-white py-2 px-6 rounded hover:bg-green-600 font-bold">Guardar Horario</button></form></div>`;
        };

        document.getElementById('admin-view').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-appointment-btn')) {
                showConfirm('Eliminar Cita', '¿Estás seguro de que quieres eliminar esta cita? Esta acción no se puede deshacer.', (confirmed) => {
                    if (confirmed) {
                        const { date, id } = target.dataset;
                        appointmentsRef.child(date).child(id).remove();
                        showNotification('Cita eliminada');
                    }
                });
            } else if (target.classList.contains('add-appointment-btn')) {
                openAdminBookingModal(target.dataset);
            } else if (target.classList.contains('delete-category-btn')) {
                const category = target.dataset.category;
                showConfirm('Eliminar Categoría', `¿Seguro que quieres eliminar "${category}"? Se eliminarán también los servicios y especialidades asociados.`, (confirmed) => {
                    if (confirmed) {
                        const newSettings = { ...appState.settings };
                        newSettings.serviceCategories = newSettings.serviceCategories.filter(c => c !== category);
                        newSettings.services = (newSettings.services || []).filter(s => s.category !== category);
                        (newSettings.staff || []).forEach(s => { s.specialties = (s.specialties || []).filter(spec => spec !== category); });
                        settingsRef.set(newSettings);
                        showNotification('Categoría eliminada');
                    }
                });
            } else if (target.classList.contains('delete-service-btn')) {
                const id = parseInt(target.dataset.id);
                const newServices = appState.settings.services.filter(s => s.id !== id);
                settingsRef.child('services').set(newServices);
                showNotification('Servicio eliminado');
            } else if (target.classList.contains('delete-staff-btn')) {
                const id = parseInt(target.dataset.id);
                const newStaff = appState.settings.staff.filter(s => s.id !== id);
                settingsRef.child('staff').set(newStaff);
                showNotification('Manicurista eliminada');
            }
        });

        document.getElementById('admin-view').addEventListener('submit', (e) => {
            e.preventDefault();
            const contentContainer = document.getElementById('admin-content');
            if (e.target.id === 'form-add-category') {
                const name = contentContainer.querySelector('#new-category-name').value.trim();
                const currentCategories = appState.settings.serviceCategories || [];
                if (name && !currentCategories.includes(name)) {
                    settingsRef.child('serviceCategories').set([...currentCategories, name]);
                    showNotification('Categoría añadida');
                }
            } else if (e.target.id === 'form-add-service') {
                const name = contentContainer.querySelector('#new-service-name').value.trim();
                const duration = parseInt(contentContainer.querySelector('#new-service-duration').value);
                const category = contentContainer.querySelector('#new-service-category').value;
                if (name && duration && category) { 
                    const newService = { id: Date.now(), name, duration, category };
                    const currentServices = appState.settings.services || [];
                    settingsRef.child('services').set([...currentServices, newService]);
                    showNotification('Servicio añadido'); 
                }
            } else if (e.target.id === 'form-add-staff') {
                const name = contentContainer.querySelector('#new-staff-name').value.trim();
                const specialties = Array.from(contentContainer.querySelectorAll('#new-staff-specialties input:checked')).map(cb => cb.value);
                if (name && specialties.length > 0) { 
                    const newStaff = { id: Date.now(), name, specialties };
                    const currentStaff = appState.settings.staff || [];
                    settingsRef.child('staff').set([...currentStaff, newStaff]);
                    showNotification('Profesional añadida');
                }
            } else if (e.target.id === 'form-hours') {
                const newHours = { start: contentContainer.querySelector('#hours-start').value, end: contentContainer.querySelector('#hours-end').value, breakStart: contentContainer.querySelector('#hours-break-start').value, breakEnd: contentContainer.querySelector('#hours-break-end').value, interval: parseInt(contentContainer.querySelector('#hours-interval').value) };
                settingsRef.child('hours').set(newHours);
                showNotification('Horario guardado');
            }
        });
        
        const openAdminBookingModal = (data) => {
            const { date, time, staff } = data;
            const modal = document.getElementById('admin-booking-modal');
            modal.querySelector('#admin-book-date').value = date;
            modal.querySelector('#admin-book-time').value = time;
            modal.querySelector('#admin-book-staff').value = staff;
            const serviceSelect = modal.querySelector('#admin-book-service');
            const staffMember = appState.settings.staff.find(s => s.name === staff);
            const qualifiedServices = appState.settings.services.filter(s => staffMember.specialties.includes(s.category));
            serviceSelect.innerHTML = qualifiedServices.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            modal.classList.remove('hidden');
        };

        document.getElementById('admin-book-cancel').addEventListener('click', () => {
             document.getElementById('admin-booking-modal').classList.add('hidden');
             document.getElementById('admin-booking-form').reset();
        });

        document.getElementById('admin-booking-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const date = document.getElementById('admin-book-date').value;
            const time = document.getElementById('admin-book-time').value;
            const staffName = document.getElementById('admin-book-staff').value;
            const clientName = document.getElementById('admin-book-client-name').value.trim();
            const clientPhone = document.getElementById('admin-book-client-phone').value.trim();
            const notes = document.getElementById('admin-book-notes').value.trim();
            const serviceId = parseInt(document.getElementById('admin-book-service').value);
            const service = appState.settings.services.find(s => s.id === serviceId);

            if (!clientName || !clientPhone || !service) {
                showNotification('Todos los campos son obligatorios', true); return;
            }
            if (!isValidColombianPhone(clientPhone)) {
                showNotification('Por favor, ingresa un número de celular válido de 10 dígitos.', true);
                return;
            }

            const appointmentData = { clientName, clientPhone, notes, serviceName: service.name, serviceDuration: service.duration, startTime: time, staffName };
            appointmentsRef.child(date).push(appointmentData);
            
            document.getElementById('admin-booking-modal').classList.add('hidden');
            e.target.reset();
            showNotification('Cita agendada manualmente');
        });

        const initializeApp = () => {
            settingsRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    appState.settings = snapshot.val();
                } else {
                    const initialSettings = getInitialState();
                    settingsRef.set(initialSettings);
                    appState.settings = initialSettings;
                }

                appointmentsRef.on('value', (snapshot) => {
                    appState.appointments = snapshot.val() || {};
                    if (adminView.offsetParent !== null) {
                         const activeTab = document.querySelector('.admin-tab.active');
                         if (activeTab && activeTab.dataset.tab === 'agenda') {
                            const datePicker = document.getElementById('admin-date-picker');
                            renderAdminAgenda(document.getElementById('admin-content'), datePicker ? datePicker.value : null);
                         }
                    }
                });

                if (sessionStorage.getItem('isAdminPeluqueria') === 'true') {
                    showAdminView();
                } else {
                    showClientView();
                }
            });
        };
        
        const showNotification = (message, isError = false) => {
            const modal = document.getElementById('notification-modal');
            const text = document.getElementById('notification-message');
            text.textContent = message;
            modal.className = `fixed bottom-10 right-10 text-white px-6 py-4 rounded-lg shadow-lg z-50 animate-bounce ${isError ? 'bg-red-600' : 'bg-[var(--primary-pink)]'}`;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('hidden'), 3000);
        };

        const showConfirm = (title, message, callback) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            
            confirmCallback = callback;
            modal.classList.remove('hidden');
        };

        const setupMobileMenu = () => {
            const desktopNav = document.querySelector('#admin-tabs-nav').parentElement;
            mobileSidebar.innerHTML = desktopNav.innerHTML;

            const toggleMobileMenu = () => {
                mobileSidebar.classList.toggle('-translate-x-full');
                mobileSidebarBackdrop.classList.toggle('hidden');
            };

            openMenuBtn.addEventListener('click', toggleMobileMenu);
            mobileSidebarBackdrop.addEventListener('click', toggleMobileMenu);

            mobileSidebar.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link) {
                    e.preventDefault();
                    renderAdminView(link.dataset.tab);
                    toggleMobileMenu();
                }
                const logoutBtn = e.target.closest('#logout-btn');
                if(logoutBtn){
                    handleLogout();
                }
            });
        };

        desktopLogoutBtn.addEventListener('click', handleLogout);

        document.getElementById('admin-tabs-nav').addEventListener('click', (e) => {
            e.preventDefault();
            const tab = e.target.closest('.admin-tab');
            if (tab) { renderAdminView(tab.dataset.tab); }
        });

        document.getElementById('admin-view').addEventListener('change', (e) => {
            if (e.target.id === 'admin-date-picker') {
                renderAdminAgenda(document.getElementById('admin-content'), e.target.value);
            }
        });

        document.getElementById('confirm-ok-btn').addEventListener('click', () => {
            if(confirmCallback) confirmCallback(true);
            document.getElementById('confirm-modal').classList.add('hidden');
        });
         document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
            if(confirmCallback) confirmCallback(false);
            document.getElementById('confirm-modal').classList.add('hidden');
        });

        initializeApp();
        setupMobileMenu();
    });
    </script>
</body>
</html>
